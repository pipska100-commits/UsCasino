import asyncio
import random
import hashlib
import aiohttp
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»Ğ¸
logging.basicConfig(level=logging.INFO)

# ================== CONFIG ==================
# Ğ—ĞĞœĞ•ĞĞ˜ Ğ­Ğ¢Ğ˜ Ğ—ĞĞĞ§Ğ•ĞĞ˜Ğ¯ ĞĞ Ğ¡Ğ’ĞĞ˜ Ğ¢ĞĞšĞ•ĞĞ«
BOT_TOKEN = "Ğ’ĞĞ¨_Ğ¢ĞĞšĞ•Ğ_Ğ‘ĞĞ¢Ğ"
CRYPTO_PAY_TOKEN = "Ğ’ĞĞ¨_ĞšĞ Ğ˜ĞŸĞ¢Ğ_Ğ¢ĞĞšĞ•Ğ"
CRYPTO_API_URL = "https://pay.crypt.bot/api"
MIN_BET = 1.0
# ============================================

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

users = {}
invoices_seen = set()

# ================== HELPERS ==================

def get_user(uid):
    if uid not in users:
        users[uid] = {
            "balance": 0.0,
            "wager": 0.0,
            "server_seed": hashlib.sha256(str(random.random()).encode()).hexdigest()
        }
    return users[uid]

async def crypto_api(method, data=None):
    headers = {"Crypto-Pay-API-Token": CRYPTO_PAY_TOKEN}
    async with aiohttp.ClientSession() as session:
        try:
            async with session.post(f"{CRYPTO_API_URL}/{method}", json=data, headers=headers) as r:
                return await r.json()
        except Exception as e:
            logging.error(f"API Error: {e}")
            return {"ok": False}

# ================== START ==================

@dp.message(Command("start"))
async def start(msg: types.Message):
    get_user(msg.from_user.id)
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ® Ğ˜Ğ³Ñ€Ñ‹", callback_data="games")],
        [InlineKeyboardButton(text="ğŸ’° ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", callback_data="profile")]
    ])
    await msg.answer("ğŸ° *UsCasino*\nĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ° 1 USDT", parse_mode="Markdown", reply_markup=kb)

# ================== PROFILE ==================

@dp.callback_query(F.data == "profile")
async def profile(call: types.CallbackQuery):
    u = get_user(call.from_user.id)
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="â• Ğ”ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚", callback_data="deposit")],
        [InlineKeyboardButton(text="â– Ğ’Ñ‹Ğ²Ğ¾Ğ´", callback_data="withdraw")],
        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="start_menu")]
    ])
    await call.message.edit_text(
        f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {u['balance']:.2f} USDT\nğŸ¯ ĞĞ±Ğ¾Ñ€Ğ¾Ñ‚: {u['wager']:.2f}",
        reply_markup=kb
    )

@dp.callback_query(F.data == "start_menu")
async def back_to_start(call: types.CallbackQuery):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ® Ğ˜Ğ³Ñ€Ñ‹", callback_data="games")],
        [InlineKeyboardButton(text="ğŸ’° ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", callback_data="profile")]
    ])
    await call.message.edit_text("ğŸ° *UsCasino*\nĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ° 1 USDT", parse_mode="Markdown", reply_markup=kb)

# ================== DEPOSIT ==================

@dp.callback_query(F.data == "deposit")
async def deposit(call: types.CallbackQuery):
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ payload, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ±Ğ¾Ñ‚ Ğ·Ğ½Ğ°Ğ», ĞºĞ¾Ğ¼Ñƒ Ğ·Ğ°Ñ‡Ğ¸ÑĞ»ÑÑ‚ÑŒ Ğ´ĞµĞ½ÑŒĞ³Ğ¸
    inv = await crypto_api("createInvoice", {
        "asset": "USDT",
        "amount": "10.0",
        "description": "UsCasino Deposit",
        "payload": str(call.from_user.id) 
    })
    
    if inv.get("ok"):
        pay_url = inv['result']['pay_url']
        await call.message.answer(f"ğŸ’³ Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ (10 USDT):\n{pay_url}")
    else:
        await call.message.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑÑ‡ĞµÑ‚Ğ°.")

async def check_invoices():
    while True:
        data = await crypto_api("getInvoices", {"status": "paid"})
        if data.get("ok"):
            for inv in data["result"]["items"]:
                inv_id = inv["invoice_id"]
                if inv_id not in invoices_seen:
                    invoices_seen.add(inv_id)
                    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· payload
                    uid_str = inv.get("payload")
                    if uid_str and uid_str.isdigit():
                        uid = int(uid_str)
                        u = get_user(uid)
                        u["balance"] += float(inv["amount"])
                        logging.info(f"Ğ—Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ {inv['amount']} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {uid}")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await bot.send_message(uid, f"âœ… Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ½Ğ° {inv['amount']} USDT!")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  except:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  pass
Â Â Â Â Â Â Â  await asyncio.sleep(10)

# ================== GAMES ==================

@dp.callback_query(F.data == "games")
async def games(call: types.CallbackQuery):
Â Â Â  kb = InlineKeyboardMarkup(inline_keyboard=[
Â Â Â Â Â Â Â  [InlineKeyboardButton(text="ğŸ² Dice", callback_data="dice_game")],
Â Â Â Â Â Â Â  [InlineKeyboardButton(text="ğŸ€ Basket", callback_data="basket")],
Â Â Â Â Â Â Â  [InlineKeyboardButton(text="ğŸ¯ Darts", callback_data="darts")],
Â Â Â Â Â Â Â  [InlineKeyboardButton(text="âš½ Football", callback_data="football")],
Â Â Â Â Â Â Â  [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="start_menu")]
Â Â Â  ])
Â Â Â  await call.message.edit_text("ğŸ® Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ñƒ:", reply_markup=kb)

@dp.callback_query(F.data == "basket")
async def basket(call: types.CallbackQuery): 
Â Â Â  await bot.send_dice(call.from_user.id, emoji="ğŸ€")

@dp.callback_query(F.data == "darts")
async def darts(call: types.CallbackQuery): 
Â Â Â  await bot.send_dice(call.from_user.id, emoji="ğŸ¯")

@dp.callback_query(F.data == "football")
async def football(call: types.CallbackQuery): 
Â Â Â  await bot.send_dice(call.from_user.id, emoji="âš½")

# ================== RUN ==================

async def main():
Â Â Â  # Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹
Â Â Â  asyncio.create_task(check_invoices())
Â Â Â  # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
Â Â Â  await dp.start_polling(bot)

if name == "__main__":
Â Â Â  try:
Â Â Â Â Â Â Â  asyncio.run(main())
Â Â Â  except (KeyboardInterrupt, SystemExit):
Â Â Â Â Â Â Â  logging.info("Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")
